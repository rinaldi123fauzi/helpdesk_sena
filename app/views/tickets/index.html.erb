<div class="modal fade" id="form-ticket" role="dialog" aria-labelledby="formModal"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="formModal"></h5>
          <button type="button" class="close" id="close-modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form method="POST" enctype="multipart/form-data" id="post">
            <input type="hidden" name="authenticity_token" id="authenticity_token" value="<%= form_authenticity_token %>">
            <input type="hidden" id="id_tiket" name="id_tiket">
            <div class="row">
              <div class="col-md-6 nomor-ticket">
                <div class="form-group">
                  <label>Nomor Tiket</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="nomor-tiket" name="nomor_tiket" readonly>
                  </div>
                </div>
              </div>
              <div class="col-md-12 dibuat-oleh">
                <div class="form-group">
                  <label>Dibuat Oleh</label>
                  <div class="input-group">
                    <input type="text" class="form-control" name="dibuat_oleh" id="dibuat-oleh" readonly>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label>Layanan</label>
                  <div class="input-group">
                    <select class="form-control select2" id="layanan" name="layanan" style="width: 100%;">
                      <option value="">--Pilih--</option>
                    </select>
                    <div class="message-layanan text-danger"></div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label>Sub Layanan</label>
                  <div class="input-group">
                    <select class="form-control select2" id="sub-layanan" name="sub_layanan" style="width: 100%;">
                      <option value="">--Pilih--</option>
                    </select>
                    <div class="message-sub-layanan text-danger"></div>
                  </div>
                </div>
              </div>
              <div id="ubah-approval1" class="col-md-6">
                <div class="form-group">
                  <label>Divisi</label>
                  <div class="input-group">
                    <select class="form-control select2" id="satuan-kerja" name="satuan_kerja" style="width: 100%;">
                      <option value="">--Pilih--</option>
                    </select>
                    <div class="message-satker text-danger"></div>
                  </div>
                </div>
              </div>
              <div id="ubah-approval2" class="col-md-6">
                <div class="form-group">
                  <label>Area</label>
                  <div class="input-group">
                    <select class="form-control select2" id="area" name="area" style="width: 100%;">
                      <option value="">--Pilih--</option>
                    </select>
                    <div class="message-area text-danger"></div>
                  </div>
                </div>
              </div>
              <div id="kucing-garong" hidden>
                <div class="form-group">
                  <label>Atasan Langsung</label>
                  <div class="input-group">
                    <select class="form-control select2" id="approval-by" name="approval_by" style="width: 100%;">
                    </select>
                  </div>
                </div>
              </div>

              <div class="col-md-12">
                <div class="form-group">
                  <label>Deskripsi <small>Optional</small></label>
                  <div class="input-group">
                    <textarea name="deskripsi" id="deskripsi"></textarea>
                  </div>
                </div>
              </div>

              <div class="col-md-12">
                <div class="form-group">
                  <label>Lampiran <small>Optional</small></label>
                  <div class="input-group">
                    <input type="file" name="file_tiket[]" class="form-control" id="file-ticket" onchange="upload()" multiple>
                    <input type="hidden" name="size_file" class="size-file">
                  </div>
                  <div class="mt-2 notif-file text-danger"></div>
                </div>
              </div>

              <div class="col-md-4">
                <button class="btn btn-sm btn-info" id="simpan">Simpan</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal Detail-->

<div class="modal fade" id="detail" tabindex="-1" role="dialog" aria-labelledby="formModal"
  aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Detail</h5>
        <button type="button" class="close" id="close-modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Nomor Tiket</label>
              <div class="input-group">
                <input type="text" class="form-control" id="detail-nomor-tiket" disabled>
              </div>
            </div>
            <div class="form-group">
              <label>Layanan</label>
              <div class="input-group">
                <input type="text" class="form-control" id="detail-layanan" disabled>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Dibuat Oleh</label>
              <div class="input-group">
                <input type="text" class="form-control" id="detail-dibuat-oleh" disabled>
              </div>
            </div>
            <div class="form-group">
              <label>Sub Layanan</label>
              <div class="input-group">
                <input type="text" class="form-control" id="detail-sub-layanan" disabled>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Divisi</label>
              <div class="input-group">
                <input type="text" class="form-control" id="detail-satuan-kerja" disabled>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Area</label>
              <div class="input-group">
                <input type="text" class="form-control" id="detail-area" disabled>
              </div>
            </div>
          </div>

          <div class="col-md-12">
            <div class="form-group">
              <label>Deskripsi</label>
              <div class="input-group">
                <textarea id="detail-deskripsi" readonly></textarea>
              </div>
            </div>
          </div>

          <div class="col-md-3">
            <div class="form-group">
              <div class="assign-teknisi"></div>
              <div class="mt-4 pending-approval"></div>
            </div>
          </div>

          <div class="col-md-7">
            <div class="form-group">
              <label>Attachment</label>
              <div class="file-button"></div>
            </div>
          </div>

          <div class="col-md-2">
            <div class="form-group">
              <label style="color: transparent;">approval</label>
              <div class="approval-button row"></div>
            </div>
          </div>

        </div>
        <hr>
        <div class="section-body">
          <h5 class="section-title">History</h5>
          <div class="row">
            <div class="col-12">
              <div class="activities">
                <div class="history"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid">
  <div class="card shadow mb-4">
      <div class="card-header mt-2">
        <h4>Data Tiket</h4>
        <div class="card-header-form">
          <%
=begin%>
 <% if current_user.can? { |permissions| permissions.ticket.create? } %> 
<%
=end%>
        <% if current_user.can? { |permissions| permissions.tiketnich.manage? }  %>
          <div class="align-items-center">
            <button class="tambah-ticket btn btn-info btn-md" data-backdrop="true" data-toggle="modal" data-target="#form-ticket">+ Tiket</button>
          </div>
        <% end %>
        </div>
      </div>

    <div class="modal fade" id="assign" role="dialog" aria-labelledby="formModal"
      aria-hidden="true">
      <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5>Assigning Ticket</h5>
            <button type="button" class="close" id="close-modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="row">
                <input type="hidden" id="id_tiket_assign">
                <div class="col-md-12">
                  <div class="form-group">
                    <label>Teknisi</label>
                    <div class="input-group">
                      <select class="form-control select2" id="assign_teknisi" style="width: 100%;">
                        <% RoleAssignment.left_outer_joins(:role,:user).where('roles.name = ?', 'teknisi').select('users.username').each do |data| %>
                          <option value="<%= data.username %>"><%= data.username %></option>
                        <% end %>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <button class="btn btn-sm btn-info" id="kirimTiket">Simpan</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="reject" role="dialog" aria-labelledby="formModal"
      aria-hidden="true">
      <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5>Reject Tiket</h5>
            <button type="button" class="close" id="close-modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="row">
                <input type="hidden" id="id_reject">
                <div class="col-md-12">
                  <div class="form-group">
                    <label>Deskripsi</label>
                    <textarea class="deskripsi-reject" maxlength="100"></textarea>
                    <div class="count-character-reject"></div>
                    <div class="notice-reject"></div>
                  </div>
                </div>
                <div class="col-md-4">
                  <button class="btn btn-sm btn-info" id="kirimReject">Simpan</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="eskalasi" role="dialog" aria-labelledby="formModal"
      aria-hidden="true">
      <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5>Pending Tiket</h5>
            <button type="button" class="close" id="close-modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="row">
                <input type="hidden" id="id-eskalasi">
                <div class="col-md-12">
                  <div class="form-group">
                    <label>Deskripsi</label>
                    <textarea class="deskripsi-eskalasi" maxlength="100"></textarea>
                    <div class="count-character"></div>
                    <div class="notice-eskalasi"></div>
                  </div>
                </div>
                <div class="col-md-4">
                  <button class="btn btn-sm btn-info" id="kirimEskalasi">Simpan</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="card-body">
      <%= form_for :tickets, url: tickets_path, method: :get, html: {class: "form-horizontal", role: "form"} do |f| %>
        <div class="row mb-2" style="margin-bottom: 0px;">
          <div class="col-sm-3">
            <input type="text" class="form-control number-ticket" name="nomor_tiket" placeholder="Search by nomor tiket" value="<%= params[:nomor_tiket] ? params[:nomor_tiket] : "" %>">
          </div>
          <button class="btn btn-md btn-info search-ticket" type="submit"><i class="fa fa-search"></i> Search</button>
        </div>
      <% end %>
      <div class="table-responsive">
        <table class="table table-bordered" id="dataTable_ticket" width="100%" cellspacing="0">
          <thead>
            <tr>
              <th class="text-center" style="width: 20px;">No</th>
              <th>Nomor Tiket</th>
              <th>Divisi</th>
              <th>Dibuat Oleh</th>
              <th>Status Tiket</th>
              <th>Tanggal Dibuat</th>
              <th class="text-center" style="width: 100px;">Action</th>
            </tr>
          </thead>
          <tbody>
            <% @tickets.each_with_index do |ticket, index| %>
              <tr>
                <td><%= index+1 %></td>
                <td><%= ticket.no_ticket %></td>
                <td><%= ticket.work_unit.nama %></td>
                <td><%= ticket.issued_by %></td>
                <td>
                  <% 
                    case ticket.status 
                    when "open"
                      if ticket.pause_respon == true
                        concat "<span class='badge badge-light'>#{ticket.status}</span> <small class='text-warning'>Pending</small>".html_safe
                      else
                        concat "<span class='badge badge-light'>#{ticket.status}</span>".html_safe
                      end
                    when "created"
                      concat "<span class='badge badge-transparent'>#{ticket.status}</span>".html_safe
                    when "closed"
                      concat "<span class='badge badge-primary'>#{ticket.status}</span>".html_safe
                    when "overdue"
                      concat "<span class='badge badge-warning'>#{ticket.status}</span>".html_safe
                    when "rejected"
                      concat "<span class='badge badge-danger'>#{ticket.status}</span>".html_safe
                    when "inprogress"
                      concat "<span class='badge badge-success'>#{ticket.status}</span>".html_safe
                    else
                      concat "<span class='badge badge-info'>Pending</span> <small class='text-warning'>Approval</small>".html_safe
                    end
                  %>
                </td>
                <td><%= ticket.created_at.try(:strftime, "%d %b %Y %H:%M:%S") %></td>
                <td>
                  <button class="btn btn-primary btn-sm detailTiket" data-backdrop="true" data-toggle="modal" data-target="#detail" data-id="<%= ticket.id %>" title="Detail"><i class="fa fa-eye"></i></button>
                  <%
                    @checkRole = RoleAssignment.left_outer_joins(:user,:role).where('users.username = ? and roles.name IN (?)', ticket.issued_by, ['teknisi', 'manajer it'])
                  %>

                  <% if current_user.roles.any? {|r| r.name == "kepala divisi"} %>
                    <% unless ticket.status == "open" || ticket.status == "closed" %>
                      <% if ticket.issued_by == current_user.username %>
                        <% if ticket.pause_respon == false %>
                          <button class="btn btn-info btn-sm editTiket" data-backdrop="true" data-toggle="modal" data-target="#form-ticket" data-id="<%= ticket.id %>" title="Edit"><i class="fa fa-pencil-square-o"></i></button>
                          <button class="btn btn-danger btn-sm hapusTiket" data-id="<%= ticket.id %>" title="Hapus"><i class="fa fa-trash-o"></i></button>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% else %>
                    <% if @checkRole.count == 1%>
                      <% unless ticket.status == "closed" or ticket.status == "inprogress" or ticket.status == "overdue" %>
                        <button class="btn btn-info btn-sm editTiket" data-backdrop="true" data-toggle="modal" data-target="#form-ticket" data-id="<%= ticket.id %>" title="Edit"><i class="fa fa-pencil-square-o"></i></button>
                        <button class="btn btn-danger btn-sm hapusTiket" data-id="<%= ticket.id %>" title="Hapus"><i class="fa fa-trash-o"></i></button>
                      <% end %>
                    <% else %>
                      <% if ticket.status == "created" || (ticket.status == "open" && ticket.sub_category.approval_berjenjang == "none") %>
                        <% if ticket.issued_by == current_user.username %>
                          <% if ticket.pause_respon == false %>
                            <button class="btn btn-info btn-sm editTiket" data-backdrop="true" data-toggle="modal" data-target="#form-ticket" data-id="<%= ticket.id %>" title="Edit"><i class="fa fa-pencil-square-o"></i></button>
                            <button class="btn btn-danger btn-sm hapusTiket" data-id="<%= ticket.id %>" title="Hapus"><i class="fa fa-trash-o"></i></button>
                          <% end %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                  <% if current_user.can? { |permissions| permissions.teknisi.manage? } %>
                    <% if ticket.status == "inprogress" || ticket.status == "overdue" %>
                      <% if ticket.pause_respon == false %>
                        <button class="btn btn-info btn-sm done" data-id="<%= ticket.id %>">Close</button>
                      <% end %>
                    <% end %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
        <i class="text-danger">* Data maksimal muncul 100 per bulan</i>
      </div>
    </div>
  </div>
</div>

<script>
  <% if @checkRole.count == 1 %>
    setInterval(() => {
      window.location.href = "/tickets";
    }, 500000);
  <% end %>
  $(document).on('keyup', '.deskripsi-eskalasi', function(){
    var value = $(this).val();
    $(".count-character").text("Characters left: " + (100 - value.length));
    $('.notice-eskalasi').empty();
  });

  $(document).on('keyup', '.deskripsi-reject', function(){
    var value = $(this).val();
    console.log(value);
    $(".count-character-reject").text("Characters left: " + (100 - value.length));
    $('.notice-reject').empty();
  });

  $(document).on('click', '.detailTiket', function(){
    var id = $(this).data('id');
    $('.file-button').empty()
    $('.pending-approval').empty()
    $.ajax({
      url: "/transaksi/tickets/detail",
      method: 'GET',
      data : {
        id:id
      },
      success: function(data)
      {
        $('#detail-nomor-tiket').val(data['data_ticket']['nomor_tiket']);
        $('#detail-dibuat-oleh').val(data['data_ticket']['dibuat_oleh']);
        $('#detail-layanan').val(data['data_ticket']['layanan']);
        $('#detail-sub-layanan').val(data['data_ticket']['sub_layanan']);
        $('#detail-area').val(data['data_ticket']['area']);
        $('#detail-satuan-kerja').val(data['data_ticket']['satuan_kerja']);
        $('#detail-deskripsi').val(data['data_ticket']['deskripsi']);
        $('#detail-teknisi').val(data['data_ticket']['teknisi']);
        $('.assign-teknisi').empty();
        $('.approval-button').empty();
        $('.history').empty();
        if (data['data_ticket']['current_user'].includes("admin") == true || data['data_ticket']['current_user'].includes("superadmin") == true || data['data_ticket']['current_user'].includes("manajer it") == true) {
          if (data['data_ticket']['status'] == "open" && data['data_ticket']['pause_respon'] == 0) {
            $('.approval-button').append(`
              <button class="btn btn-primary btn-sm assign mb-2" data-backdrop="true" data-toggle="modal" data-target="#assign" data-id="${id}">Assigning</button>
            `);
          }
        }

        if (data['data_ticket']['current_user'].includes("teknisi") == true) {
          if (data['data_ticket']['status'] == "open" && data['data_ticket']['pause_respon'] == 0) {
            $('.approval-button').append(`
              <button class="btn btn-info btn-sm take-ticket" data-id="${id}">Take a ticket</button>
            `);
          }
        }

        if (data['data_ticket']['current_user'].includes("teknisi") == true && data['data_ticket']['teknisi'] == data['data_ticket']['user']) {
          if (data['data_ticket']['status'] == "inprogress") {
            $('.approval-button').append(`
              <button class="btn btn-info btn-sm eskalasi" data-backdrop="true" data-toggle="modal" data-target="#eskalasi" data-id="${id}">Pending Tiket</button>
            `);
          }else if(data['data_ticket']['status'] == "open" && data['data_ticket']['pause_respon'] == 1){
            $('.approval-button').append(`
              <button class="btn btn-info btn-sm col-md-6 proccess" data-id="${id}">Process</button>
            `);
          }
        }

        $('.assign-teknisi').append(`
          <label>Teknisi</label>
          <input type="text" class="form-control" value="${data['data_ticket']['teknisi']}" disabled>
        `);

        if (data['data_ticket']['approval_by'] == data['data_ticket']['user']) {
          if (data['data_ticket']['pending_approval']['status'] == "created" || data['data_ticket']['pending_approval']['status'] == "approval1" || data['data_ticket']['pending_approval']['status'] == "approval2" || data['data_ticket']['pending_approval']['status'] == "approval3") {
            $('.approval-button').append(`
             <button class="btn btn-info btn-sm col-md-6 approve" data-id="${id}">Approve</button>
           `);
           $('.approval-button').append(`
             <button class="btn btn-danger btn-sm col-md-5 ml-2 reject" data-backdrop="true" data-toggle="modal" data-target="#reject" data-id="${id}">Reject</button>
           `);
          }
        }

        for (let i = 0; i < data['data_ticket']['file'].length; i++) {
          const element = data['data_ticket']['file'][i];
          $('.file-button').append(`
            <a href="${element['link']}" target="_blank">${element['nama_file']}</a><br>
          `);          
        }

        for (let i = 0; i < data['data_ticket']['history'].length; i++) {
          const element = data['data_ticket']['history'][i];
          $('.history').append(`
            <div class="activity">
              <div class="activity-icon bg-primary text-white">
                <i class="fas fa-history"></i>
              </div>
              <div class="activity-detail">
                <div class="mb-2">
                  <span class="text-job">${element['created_at']}</span>
                  <span class="bullet"></span>
                  <a class="text-job" href="#">${element['issued_by']}</a>
                </div>
                <small style="font-weight: bold;">Status : ${element['approve_level']}</small>
                <p>${element['description']}</p>
              </div>
            </div>
          `);
        }

        if (data['data_ticket']['pending_approval']['status'] == "created" || data['data_ticket']['pending_approval']['status'] == "approval1" || data['data_ticket']['pending_approval']['status'] == "approval2" || data['data_ticket']['pending_approval']['status'] == "approval3") {
          $('.pending-approval').append(`
            <span class="badge badge-warning">Pending approval by : ${data['data_ticket']['pending_approval']['approval_by']}</span>
          `);
        }else if(data['data_ticket']['pending_approval']['status'] == "rejected"){
          $('.pending-approval').append(`
            <span class="badge badge-danger">Rejected by : ${data['data_ticket']['pending_approval']['approval_by']}</span>
          `);
        }
      }
    });
  });

  $(document).on('click', '.reject', function(){
    var id = $(this).data('id');
    $('#id_reject').val(id);
  });

  $(document).on('click', '#kirimReject', function(e){
    e.preventDefault();
    var id = $('#id_reject').val();
    var deskripsi = $('.deskripsi-reject').val();
    $('#kirimReject').text('Loading...');
    $.ajax({
      url: "/transaksi/approve/ticket-reject",
      method: 'POST',
      data : {
        authenticity_token: '<%= form_authenticity_token %>',
        id:id,
        deskripsi:deskripsi
      },
      success: function(data){
        if (data['status'] == 200) {
          window.location.href = "/tickets";
        }else if (data['status'] == 204) {
          $('#kirimReject').text('Submit');
          $('.notice-reject').html(`<span class="text-danger">Deskripsi wajib diisi</span>`);
        }
      }
    });
  });

  $(document).on('click', '.eskalasi', function(){
    var id = $(this).data('id');
    $('#id-eskalasi').val(id);
  });

  $(document).on('click', '#kirimEskalasi', function(e){
    e.preventDefault();
    var id = $('#id-eskalasi').val();
    var deskripsi = $('.deskripsi-eskalasi').val();
    $('#kirimEskalasi').text('Loading...');
    $('.notice-eskalasi').empty();
    $.ajax({
      url: "/transaksi/teknisi/ticket-eskalasi",
      method: 'POST',
      data : {
        authenticity_token: '<%= form_authenticity_token %>',
        id:id,
        deskripsi:deskripsi
      },
      success: function(data){
        if (data['status'] == 200) {
          window.location.href = "/tickets";
        }else if (data['status'] == 204) {
          $('#kirimEskalasi').text('Simpan');
          $('.notice-eskalasi').html(`<span class="text-danger">${data['msg']}</span>`);
        }
      }
    });
  });

  $(document).on('click', '.editTiket', function(){
    $('.modal-title').text('Ubah Tiket');
    var id = $(this).data('id');
    $('#post')[0].reset();
    $('#layanan').find('option:not(:first)').remove();
    $('#sub-layanan').find('option:not(:first)').remove();
    $('#area').find('option:not(:first)').remove();
    $('#satuan-kerja').find('option:not(:first)').remove();
    $('.nomor-ticket').prop('hidden', false);
    $('.dibuat-oleh').removeClass('col-md-12');
    $('.dibuat-oleh').addClass('col-md-6');
    $.ajax({
      url: "/transaksi/tickets/detail-tiket",
      method: 'GET',
      data : {
        authenticity_token: '<%= form_authenticity_token %>',
        id:id
      },
      success: function(data)
      {
        $('#id_tiket').val(data[0]['data_ticket']['id'])
        $('#nomor-tiket').val(data[0]['data_ticket']['no_ticket']);
        $('#dibuat-oleh').val(data[0]['data_ticket']['issued_by']);
        $('#deskripsi').val(data[0]['data_ticket']['description']);
        var sub_category_id = data[0]['data_ticket']['sub_category_id'];
        var follow_by = data[0]['data_ticket']['approval_by'];
        for (let i = 0; i < data[0]['categories'].length; i++) {
          const element = data[0]['categories'][i];
          if (data[0]['data_ticket']['category_id'] == element['id']) {
            $('#layanan').append(`
              <option value="${element['id']}" selected>${element['nama_kategori']}</option>
            `);
          }else{
            $('#layanan').append(`
              <option value="${element['id']}">${element['nama_kategori']}</option>
            `);
          }
        }

        for (let i = 0; i < data[0]['areas'].length; i++) {
          const element = data[0]['areas'][i];
          if (data[0]['data_ticket']['area_id'] == element['id']) {
            $('#area').append(`
              <option value="${element['id']}" selected>${element['nama']}</option>
            `);
          }else{
            $('#area').append(`
              <option value="${element['id']}">${element['nama']}</option>
            `);
          }
        }

        for (let i = 0; i < data[0]['work_units'].length; i++) {
          const element = data[0]['work_units'][i];
          if (data[0]['data_ticket']['work_unit_id'] == element['id']) {
            $('#satuan-kerja').append(`
              <option value="${element['id']}" selected>${element['nama']}</option>
            `);
          }else{
            $('#satuan-kerja').append(`
              <option value="${element['id']}">${element['nama']}</option>
            `);
          }
        }

        var kategori = $('#layanan option:selected').val();
        $.ajax({
          url: "/transaksi/tickets/list-sub-category",
          method: 'GET',
          data :{
            category_id:kategori
          },
          success: function(data)
          {
            $('#sub-layanan').empty();
            $('#sub-layanan').append(`
                  <option value="">--Pilih--</option>
            `);
            for (let i = 0; i < data[0]['sub_category'].length; i++) {
              const element = data[0]['sub_category'][i];
              if (sub_category_id == element['id']) {
                $('#sub-layanan').append(`
                  <option value="${element['id']}" selected>${element['nama_sub_kategori']}</option>
                `);
              }else{
                $('#sub-layanan').append(`
                  <option value="${element['id']}">${element['nama_sub_kategori']}</option>
                `);
              }
            }

            var sub_kategori = $('#sub-layanan option:selected').val();
            $.ajax({
              url: "/transaksi/tickets/get-approval-berjenjang",
              method: 'GET',
              data: {
                id:sub_kategori
              },
              success: function(data)
              {
                $('#approval-by').empty();
                if (data['status_approval'] != "none") {
                  for (let i = 0; i < data['user'].length; i++) {
                    const element = data['user'][i];
                    if (follow_by == element['username']) {
                      $('#approval-by').append(`<option value="${element['username']}" selected>${element['username']}</option>`);
                    }else{
                      $('#approval-by').append(`<option value="${element['username']}">${element['username']}</option>`);
                    }
                  }
                  $('#kucing-garong').prop('hidden', false);
                  $('#ubah-approval1').removeClass();
                  $('#ubah-approval2').removeClass();
                  $('#ubah-approval1').addClass('col-md-4');
                  $('#ubah-approval2').addClass('col-md-4');
                  $('#kucing-garong').addClass('col-md-4');
                  console.log(data['user']);
                }else{
                  $('#kucing-garong').prop('hidden', true);
                  $('#kucing-garong').removeClass();
                  $('#ubah-approval1').removeClass();
                  $('#ubah-approval2').removeClass();
                  $('#ubah-approval1').addClass('col-md-6');
                  $('#ubah-approval2').addClass('col-md-6');
                }
              }
            });
          }
        });

        $(document).on('change', '#satuan-kerja', function(){
          var id = $(this).val();
          $.ajax({
            url: "/transaksi/tickets/satuan-kerja",
            method: 'GET',
            data :{
              id:id
            },
            success: function(data)
            {
              $('#approval-by').empty();
              $('#approval-by').append(`
                    <option value="">--Pilih--</option>
              `);
              if (data['status']['punya_pm'] == true) {
                for (let i = 0; i < data['user_biasa'].length; i++) {
                  const element = data['user_biasa'][i];
                  $('#approval-by').append(`
                    <option value="${element['username']}">${element['username']}</option>
                  `);
                }
              }else if(data['status']['punya_pm'] == false){
                 $('#approval-by').append(`
                  <option value="${data['username']}">${data['username']}</option>
                `);
              }
            }
          });
        });

        $(document).on('change', '#layanan', function(){
          var id = $(this).val();
          $.ajax({
            url: "/transaksi/tickets/list-sub-category",
            method: 'GET',
            data :{
              category_id:id
            },
            success: function(data)
            {
              $('#sub-layanan').empty();
              $('#sub-layanan').append(`
                    <option value="">--Pilih--</option>
              `);
              for (let i = 0; i < data[0]['sub_category'].length; i++) {
                const element = data[0]['sub_category'][i];
                $('#sub-layanan').append(`
                  <option value="${element['id']}">${element['nama_sub_kategori']}</option>
                `);
              }
            }
          });
        });

        $(document).on('change', '#sub-layanan', function(){
          var id = $(this).val();
          $.ajax({
            url: "/transaksi/tickets/get-approval-berjenjang",
            method: 'GET',
            data: {
              id:id
            },
            success: function(data)
            {
              $('#approval-by').empty();
             if (data['status_approval'] != "none") {
              for (let i = 0; i < data['user'].length; i++) {
                const element = data['user'][i];
                $('#approval-by').append(`<option value="${element['username']}">${element['username']}</option>`);
              }
              $('#kucing-garong').prop('hidden', false);
              $('#ubah-approval1').removeClass();
              $('#ubah-approval2').removeClass();
              $('#ubah-approval1').addClass('col-md-4');
              $('#ubah-approval2').addClass('col-md-4');
              $('#kucing-garong').addClass('col-md-4');
              console.log(data['user']);
             }else{
              $('#kucing-garong').prop('hidden', true);
              $('#kucing-garong').removeClass();
              $('#ubah-approval1').removeClass();
              $('#ubah-approval2').removeClass();
              $('#ubah-approval1').addClass('col-md-6');
              $('#ubah-approval2').addClass('col-md-6');
             }
            }
          });
        });
      }
    });
  });

  $(document).on('click','.proccess',function(e){
    e.preventDefault();
    var id = $(this).data('id');
    Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, proccess it!'
      }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: "/transaksi/teknisi/proccess-ticket",
          method: 'PUT',
          data : {
            authenticity_token: '<%= form_authenticity_token %>',
            id:id
          },
          success: function(data)
          {
            if (data['status'] == 200) {
              window.location.href = "/tickets";
            }else if (data['status'] == 500) {
              window.location.href = "/tickets";
            }
          }
        });
        Swal.fire(
          'Processed!',
          'Data has been save.',
          'success'
        )
      }
    });    
  });

  $(document).on('click','.take-ticket',function(e){
    e.preventDefault();
    var id = $(this).data('id');
    Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, take it!'
      }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: "/transaksi/teknisi/take-ticket",
          method: 'PUT',
          data : {
            authenticity_token: '<%= form_authenticity_token %>',
            id:id
          },
          success: function(data)
          {
            if (data['status'] == 200) {
              window.location.href = "/tickets";
            }
          }
        });
        Swal.fire(
          'Taked!',
          'Data has been save.',
          'success'
        )
      }
    });    
  });


  $(document).on('click','.hapusTiket',function(e){
    e.preventDefault();
    var id = $(this).data('id');
    Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, delete it!'
      }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: "/transaksi/tickets/delete-ticket",
          method: 'DELETE',
          data : {
            authenticity_token: '<%= form_authenticity_token %>',
            id:id
          },
          success: function(data)
          {
            if (data['status'] == 200) {
              window.location.href = "/tickets";
            }else if (data['status'] == 500) {
              window.location.href = "/tickets";
            }
          }
        });
        Swal.fire(
          'Deleted!',
          'Your file has been deleted.',
          'success'
        )
      }
    });    
  });

  $(document).on('click','.approve',function(e){
    e.preventDefault();
    var id = $(this).data('id');
    Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, approve it!'
      }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: "/transaksi/approve/ticket-approval",
          method: 'PUT',
          data : {
            authenticity_token: '<%= form_authenticity_token %>',
            id:id
          },
          success: function(data)
          {
            if (data['status'] == 200) {
              window.location.href = "/tickets";
            }else if (data['status'] == 500) {
              window.location.href = "/tickets";
            }
          }
        });
        Swal.fire(
          'Approved!',
          'Data has been saved.',
          'success'
        )
      }
    });    
  });

  $(document).on('click', '.assign', function(){
    var id = $(this).data('id');
    $('#id_tiket_assign').val(id);
  });

  $(document).on('click', '#kirimTiket', function(e){
    e.preventDefault();
    var id = $('#id_tiket_assign').val();
    var teknisi = $('#assign_teknisi').val();
    $('#kirimTiket').text('Loading...');
    $.ajax({
      url: "/transaksi/admin/ticket-assign",
      method: 'PUT',
      data:{
        authenticity_token: '<%= form_authenticity_token %>',
        id:id,
        teknisi:teknisi
      },
      success: function(data)
      {
        if (data.status == "tersimpan") {
          window.location.href = "/tickets";
        }
      }
    });
  });

  $(document).on('click', '.done', function(){
    var id = $(this).data('id');
    Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, closed it!'
      }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: "/transaksi/teknisi/ticket-close",
          method: 'PUT',
          data:{
            authenticity_token: '<%= form_authenticity_token %>',
            id:id
          },
          success: function(data)
          {
            if (data.status == "tersimpan") {
              window.location.href = "/tickets";
            }
          }
        });
        Swal.fire(
          'Success!',
          'Your data has been saved.',
          'success'
        )
      }
    });
  });

  $(document).on('click', '.tambah-ticket', function(){
    $('.modal-title').text('Buat Tiket');
    // reset form
    $('#post')[0].reset();
    $('#layanan').find('option:not(:first)').remove();
    $('#sub-layanan').find('option:not(:first)').remove();
    $('#area').find('option:not(:first)').remove();
    $('#satuan-kerja').find('option:not(:first)').remove();

    $('#kucing-garong').prop('hidden', true);
    $('#kucing-garong').removeClass();
    $('#ubah-approval1').removeClass();
    $('#ubah-approval2').removeClass();
    $('#ubah-approval1').addClass('col-md-6');
    $('#ubah-approval2').addClass('col-md-6');
    $('.nomor-ticket').prop('hidden', true);
    $('.dibuat-oleh').removeClass('col-md-6');
    $('.dibuat-oleh').addClass('col-md-12');
    $.ajax({
      url: "/transaksi/tickets/list-form",
      method: 'GET',
      success: function(data)
      {
        $('#dibuat-oleh').val(data[0]['dibuat_oleh']);
        for (let i = 0; i < data[0]['categories'].length; i++) {
          const element = data[0]['categories'][i];
          $('#layanan').append(`
            <option value="${element['id']}">${element['nama_kategori']}</option>
          `);
        }

        for (let i = 0; i < data[0]['areas'].length; i++) {
          const element = data[0]['areas'][i];
          $('#area').append(`
            <option value="${element['id']}">${element['nama']}</option>
          `);
        }

        for (let i = 0; i < data[0]['work_units'].length; i++) {
          const element = data[0]['work_units'][i];
          $('#satuan-kerja').append(`
            <option value="${element['id']}">${element['nama']}</option>
          `);
        }

        $(document).on('change', '#layanan', function(){
          var id = $(this).val();
          $.ajax({
            url: "/transaksi/tickets/list-sub-category",
            method: 'GET',
            data :{
              category_id:id
            },
            success: function(data)
            {
              $('#sub-layanan').empty();
              $('#sub-layanan').append(`
                    <option value="">--Pilih--</option>
              `);
              for (let i = 0; i < data[0]['sub_category'].length; i++) {
                const element = data[0]['sub_category'][i];
                $('#sub-layanan').append(`
                  <option value="${element['id']}">${element['nama_sub_kategori']}</option>
                `);
              }
            }
          });
        });

        $(document).on('change', '#sub-layanan', function(){
          var id = $(this).val();
          $.ajax({
            url: "/transaksi/tickets/get-approval-berjenjang",
            method: 'GET',
            data: {
              id:id
            },
            success: function(data)
            {
              $('#approval-by').empty();
              $('#deskripsi').empty();
              $('#deskripsi').val(data['template_ticket']);
             if (data['status_approval'] != "none") {
              for (let i = 0; i < data['user'].length; i++) {
                const element = data['user'][i];
                $('#approval-by').append(`<option value="${element['username']}">${element['username']}</option>`);
              }
              $('#kucing-garong').prop('hidden', false);
              $('#ubah-approval1').removeClass();
              $('#ubah-approval2').removeClass();
              $('#ubah-approval1').addClass('col-md-4');
              $('#ubah-approval2').addClass('col-md-4');
              $('#kucing-garong').addClass('col-md-4');
              console.log(data['user']);
             }else{
              $('#kucing-garong').prop('hidden', true);
              $('#kucing-garong').removeClass();
              $('#ubah-approval1').removeClass();
              $('#ubah-approval2').removeClass();
              $('#ubah-approval1').addClass('col-md-6');
              $('#ubah-approval2').addClass('col-md-6');
             }
            }
          });
        });

        $(document).on('change', '#satuan-kerja', function(){
          var id = $(this).val();
          $.ajax({
            url: "/transaksi/tickets/satuan-kerja",
            method: 'GET',
            data :{
              id:id
            },
            success: function(data)
            {
              $('#approval-by').empty();
              $('#approval-by').append(`
                    <option value="">--Pilih--</option>
              `);
              if (data['status']['punya_pm'] == true) {
                for (let i = 0; i < data['user_biasa'].length; i++) {
                  const element = data['user_biasa'][i];
                  $('#approval-by').append(`
                    <option value="${element['username']}">${element['username']}</option>
                  `);
                }
              }else if(data['status']['punya_pm'] == false){
                 $('#approval-by').append(`
                  <option value="${data['username']}">${data['username']}</option>
                `);
              }
            }
          });
        });
      }
    });
  });

  const btn_simpan = document.querySelector('#simpan');
  const form_inventory = document.querySelector('form');

  btn_simpan.addEventListener('click', (e) => {
    e.preventDefault();
    const formData = new FormData(form_inventory);
    var id_tiket = $('#id_tiket').val();
    $('#simpan').text('Loading...');
    $('.message-satker').empty();
    $('.message-area').empty();
    $('.message-layanan').empty();
    $('.message-sub-layanan').empty();
    $('.notif-file').empty();
    let xhr = new XMLHttpRequest();  
    if (id_tiket == "") {
      xhr.open("POST", "/transaksi/tickets/create", true);
      xhr.send(formData);
    }else{
      xhr.open("PUT", "/transaksi/tickets/update", true);
      xhr.send(formData);
    }

    xhr.addEventListener("load", function(e){
      let result = JSON.parse(xhr.response);
      if (result.status == 200) {
        window.location.href = "/tickets";
      }else if(result.status == 500){
        $('#simpan').text('Simpan');
        $('.message-satker').text(result.msg.work_unit);
        $('.message-area').text(result.msg.area);
        if (result.kategori == "layanan") {
          $('.message-layanan').text(result.msg);
        }
        if (result.kategori == "sub layanan") {
          $('.message-sub-layanan').text(result.msg);
        }
      }else if(result.status == 204){
        $('#simpan').text('Simpan');
        $('.notif-file').text('File harus dibawah 5 MB');
      }
    });
  });

  function upload() {
    var fileInput = document.getElementById('file-ticket').files;
    var value = [];
    var totalSize = 0;
    for (var i = 0; i < fileInput.length; i++){
      totalSize += fileInput[i].size / 1024 / 1024;
    }
    var sizeEncrypt = totalSize.toFixed(2);
    $('.size-file').val(sizeEncrypt);
  }
</script>

